<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>SmartLoanCalc</title>
    <link rel="stylesheet" th:href="@{/css/main.css}" href="/css/main.css"/>
    <script defer th:src="@{/js/calculator.js}" src="/js/calculator.js"></script>
</head>
<body>
<header class="topbar">
    <div class="logo">SmartLoanCalc</div>
    <nav>
        <a th:href="@{/calculator}">Калькулятор</a>
        <a th:href="@{/history}" th:if="${authenticated}">История</a>
        <a th:href="@{/login}" th:if="${!authenticated}">Вход</a>
        <form th:action="@{/logout}" method="post" th:if="${authenticated}">
            <button type="submit" class="link-button">Выход</button>
        </form>
    </nav>
</header>

<main class="layout">
    <section class="card">
        <h1>Расчёт кредита</h1>
        <div class="info" th:if="${loanRequestFromHistory}">Форма заполнена параметрами из истории</div>
        <div class="error" th:if="${error}" th:text="${error}"></div>
        <form th:action="@{/calculator}" th:object="${loanRequest}" method="post">
            <div class="grid-2">
                <label>Валюта
                    <select th:field="*{currency}">
                        <option th:each="cur : ${currencies}"
                                th:value="${cur}"
                                th:text="${cur.getDisplayName()}"></option>
                    </select>
                </label>
                <label>Тип платежа
                    <select th:field="*{paymentType}">
                        <option th:each="type : ${paymentTypes}"
                                th:value="${type}"
                                th:text="${type.getDisplayName()}"></option>
                    </select>
                </label>
                <label>Тип кредита
                    <select th:field="*{loanType}">
                        <option th:value="CONSUMER">Потребительский</option>
                        <option th:value="MORTGAGE">Ипотека</option>
                    </select>
                </label>
                <label>Сумма, ₽ *
                    <input type="number" th:field="*{principal}" step="any" min="1000" required/>
                    <span class="field-error" th:if="${#fields.hasErrors('principal')}" th:errors="*{principal}"></span>
                </label>
                <label>Ставка, % *
                    <input type="number" th:field="*{interestRate}" step="0.01" min="0.1" required/>
                    <span class="field-error" th:if="${#fields.hasErrors('interestRate')}" th:errors="*{interestRate}"></span>
                </label>
                <label>Срок, месяцев *
                    <input type="number" th:field="*{durationMonths}" min="1" max="600" required/>
                    <span class="field-error" th:if="${#fields.hasErrors('durationMonths')}" th:errors="*{durationMonths}"></span>
                </label>
                <label>Дата выдачи *
                    <input type="date" th:field="*{disbursementDate}" required/>
                    <span class="field-error" th:if="${#fields.hasErrors('disbursementDate')}" th:errors="*{disbursementDate}"></span>
                </label>
                <label>Способ перерасчёта
                    <select th:field="*{recalculationMode}">
                        <option th:each="mode : ${recalculationModes}"
                                th:value="${mode}"
                                th:text="${mode.getDisplayName()}"></option>
                    </select>
                </label>
                <label class="checkbox">
                    <input type="checkbox" th:field="*{adjustWeekends}"/>
                    <span>Переносить платежи с выходных на будни</span>
                </label>
                <label class="checkbox" th:if="${authenticated}">
                    <input type="checkbox" th:field="*{saveToHistory}"/>
                    <span>Сохранить в историю</span>
                </label>
            </div>

            <!-- Субсидия от застройщика (только для ипотеки) -->
            <div id="subsidySection" style="display:none;">
                <h2>Субсидия от застройщика</h2>
                <div class="grid-2">
                    <label class="checkbox" style="grid-column: span 2;">
                        <input type="checkbox" th:field="*{developerSubsidy}" id="developerSubsidyCheckbox"/>
                        <span>Субсидированная ипотека от застройщика</span>
                    </label>
                </div>
                <div id="subsidyFields" class="grid-2" th:classappend="${loanRequest.developerSubsidy} ? '' : 'hidden'">
                    <label>Срок субсидии, месяцев *
                        <input type="number" th:field="*{subsidyDurationMonths}" min="1" max="600" placeholder="Срок субсидии"/>
                        <span class="field-error" th:if="${#fields.hasErrors('subsidyDurationMonths')}" th:errors="*{subsidyDurationMonths}"></span>
                    </label>
                    <label>Платёж в льготный период, ₽
                        <input type="number" th:field="*{subsidizedPaymentAmount}" step="0.01" min="0" placeholder="Оставьте пустым для авторасчёта"/>
                        <span class="hint">Если не указано — рассчитывается по льготной ставке</span>
                    </label>
                    <label>Льготная ставка, %
                        <input type="number" th:field="*{subsidizedRate}" step="0.01" min="0" placeholder="Для расчёта процентов"/>
                        <span class="field-error" th:if="${#fields.hasErrors('subsidizedRate')}" th:errors="*{subsidizedRate}"></span>
                    </label>
                    <label>Режим субсидии
                        <select th:field="*{subsidyMode}">
                            <option th:each="mode : ${subsidyModes}"
                                    th:value="${mode}"
                                    th:text="${mode.getDisplayName()}"></option>
                        </select>
                    </label>
                </div>
            </div>

            <h2>Изменяемая процентная ставка</h2>
            <div id="rate-change-list" class="dynamic-list"
                 th:attr="data-index=${#lists.size(loanRequest.rateChanges)}"
                 data-prefix="rateChanges"
                 data-template="rate-change-template">
                <div class="early-payment-row header">
                    <span>Дата начала</span>
                    <span>Новая ставка %</span>
                    <span></span>
                </div>
                <div class="early-payment-row dynamic-row" th:each="period,iterStat : *{rateChanges}">
                    <input type="date"
                           th:name="|rateChanges[${iterStat.index}].startDate|"
                           th:value="${period.startDate}"
                           data-field="startDate"/>
                    <input type="number" step="0.01"
                           th:name="|rateChanges[${iterStat.index}].newRate|"
                           th:value="${period.newRate}"
                           placeholder="Ставка"
                           data-field="newRate"/>
                    <button type="button" class="danger" onclick="removeRow(this, 'rate-change-list')">×</button>
                </div>
            </div>
            <button type="button" class="secondary" onclick="addDynamicRow('rate-change-list')">Добавить период</button>

            <h2>Досрочные выплаты</h2>
            <h3>Единовременные</h3>
            <div id="one-time-payment-list" class="dynamic-list"
                 th:attr="data-index=${#lists.size(loanRequest.earlyPayments)}"
                 data-prefix="earlyPayments"
                 data-template="one-time-payment-template">
                <div class="early-payment-row header">
                    <span>Дата</span>
                    <span>Сумма</span>
                    <span>Списать</span>
                    <span></span>
                </div>
                <div class="early-payment-row dynamic-row" th:each="payment,iterStat : *{earlyPayments}">
                    <input type="date"
                           th:field="*{earlyPayments[__${iterStat.index}__].paymentDate}"
                           data-field="paymentDate"/>
                    <input type="number" min="1" step="any"
                           th:field="*{earlyPayments[__${iterStat.index}__].amount}"
                           placeholder="Сумма"
                           data-field="amount"/>
                    <select th:field="*{earlyPayments[__${iterStat.index}__].applicationMode}"
                            data-field="applicationMode">
                        <option th:each="mode : ${applicationModes}"
                                th:value="${mode}"
                                th:text="${mode.getDisplayName()}"></option>
                    </select>
                    <button type="button" class="danger" onclick="removeRow(this, 'one-time-payment-list')">×</button>
                </div>
            </div>
            <button type="button" class="secondary" onclick="addDynamicRow('one-time-payment-list')">Добавить платёж</button>

            <h3>Периодические</h3>
            <div id="periodic-payment-list" class="dynamic-list"
                 th:attr="data-index=${#lists.size(loanRequest.periodicEarlyPayments)}"
                 data-prefix="periodicEarlyPayments"
                 data-template="periodic-payment-template">
                <div class="early-payment-row header">
                    <span>Дата старта</span>
                    <span>Дата окончания</span>
                    <span>Интервал (мес)</span>
                    <span>Сумма</span>
                    <span>Списать</span>
                    <span></span>
                </div>
                <div class="early-payment-row dynamic-row" th:each="payment,iterStat : *{periodicEarlyPayments}">
                    <div class="field-container">
                        <input type="date"
                               th:field="*{periodicEarlyPayments[__${iterStat.index}__].startDate}"
                               data-field="startDate"/>
                        <span class="field-error" th:if="${#fields.hasErrors('periodicEarlyPayments[' + iterStat.index + '].startDate')}" th:errors="*{periodicEarlyPayments[__${iterStat.index}__].startDate}"></span>
                    </div>
                    <div class="field-container">
                        <input type="date"
                               th:field="*{periodicEarlyPayments[__${iterStat.index}__].endDate}"
                               data-field="endDate"
                               placeholder="Необязательно"/>
                        <span class="field-error" th:if="${#fields.hasErrors('periodicEarlyPayments[' + iterStat.index + '].endDate')}" th:errors="*{periodicEarlyPayments[__${iterStat.index}__].endDate}"></span>
                    </div>
                    <div class="field-container">
                        <input type="number" min="1" step="1"
                               th:field="*{periodicEarlyPayments[__${iterStat.index}__].intervalMonths}"
                               data-field="intervalMonths"/>
                        <span class="field-error" th:if="${#fields.hasErrors('periodicEarlyPayments[' + iterStat.index + '].intervalMonths')}" th:errors="*{periodicEarlyPayments[__${iterStat.index}__].intervalMonths}"></span>
                    </div>
                    <div class="field-container">
                        <input type="number" min="1" step="any"
                               th:field="*{periodicEarlyPayments[__${iterStat.index}__].amount}"
                               data-field="amount"/>
                        <span class="field-error" th:if="${#fields.hasErrors('periodicEarlyPayments[' + iterStat.index + '].amount')}" th:errors="*{periodicEarlyPayments[__${iterStat.index}__].amount}"></span>
                    </div>
                    <select th:field="*{periodicEarlyPayments[__${iterStat.index}__].applicationMode}"
                            data-field="applicationMode">
                        <option th:each="mode : ${applicationModes}"
                                th:value="${mode}"
                                th:text="${mode.getDisplayName()}"></option>
                    </select>
                    <button type="button" class="danger" onclick="removeRow(this, 'periodic-payment-list')">×</button>
                </div>
            </div>
            <button type="button" class="secondary" onclick="addDynamicRow('periodic-payment-list')">Добавить периодический платёж</button>

            <div class="actions">
                <button type="submit">Рассчитать</button>
            </div>
        </form>
    </section>

    <section class="card" th:if="${result}">
        <h2>Итоги</h2>
        <div class="totals">
            <div>
                <span class="label">Общая выплата</span>
                <span th:text="${result.currency + ' ' + #numbers.formatDecimal(result.totalPayment, 1, 'COMMA', 2, 'POINT')}"></span>
            </div>
            <div>
                <span class="label">Переплата (проценты)</span>
                <span th:text="${result.currency + ' ' + #numbers.formatDecimal(result.totalInterest, 1, 'COMMA', 2, 'POINT')}"></span>
            </div>
        </div>
        <!-- Информация о субсидии -->
        <div class="totals subsidy-info" th:if="${result.developerSubsidy}">
            <div>
                <span class="label">Платёж в период субсидии</span>
                <span th:text="${result.currency + ' ' + #numbers.formatDecimal(result.subsidizedPayment, 1, 'COMMA', 2, 'POINT')}"></span>
            </div>
            <div>
                <span class="label">Платёж после субсидии (платёжный шок)</span>
                <span th:text="${result.currency + ' ' + #numbers.formatDecimal(result.fullPayment, 1, 'COMMA', 2, 'POINT')}"></span>
            </div>
            <div th:if="${result.balanceAfterSubsidy != null}">
                <span class="label">Остаток долга после субсидии</span>
                <span th:text="${result.currency + ' ' + #numbers.formatDecimal(result.balanceAfterSubsidy, 1, 'COMMA', 2, 'POINT')}"></span>
            </div>
            <div>
                <span class="label">Субсидия от застройщика (всего)</span>
                <span th:text="${result.currency + ' ' + #numbers.formatDecimal(result.totalSubsidy, 1, 'COMMA', 2, 'POINT')}"></span>
            </div>
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                <tr>
                    <th>#</th>
                    <th>Дата</th>
                    <th>Платёж</th>
                    <th>Основной долг</th>
                    <th>%</th>
                    <th>Остаток</th>
                    <th th:if="${result.developerSubsidy}">Субсидия</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="item : ${result.schedule}" th:classappend="${item.earlyPayment} ? 'early-payment-row-highlight' : ''">
                    <td th:if="${item.earlyPayment}" class="early-payment-label">Досрочный</td>
                    <td th:unless="${item.earlyPayment}" th:text="${item.monthNumber}"></td>
                    <td th:text="${#temporals.format(item.paymentDate, 'dd.MM.yyyy')}"></td>
                    <td th:text="${item.paymentAmount}"></td>
                    <td th:text="${item.principalPart}"></td>
                    <td th:text="${item.interestPart}"></td>
                    <td th:text="${item.remainingDebt}"></td>
                    <td th:if="${result.developerSubsidy}" th:text="${item.subsidyAmount}"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>
</main>

<template id="one-time-payment-template">
    <div class="early-payment-row dynamic-row">
        <input type="date" data-field="paymentDate"/>
        <input type="number" min="1" step="any" placeholder="Сумма" data-field="amount"/>
        <select data-field="applicationMode">
            <option value="ON_PAYMENT_DATE">В дату платежа</option>
            <option value="BETWEEN_PAYMENTS">Между платежами</option>
        </select>
        <button type="button" class="danger" onclick="removeRow(this, 'one-time-payment-list')">×</button>
    </div>
</template>

<template id="periodic-payment-template">
    <div class="early-payment-row dynamic-row">
        <div class="field-container">
            <input type="date" data-field="startDate"/>
        </div>
        <div class="field-container">
            <input type="date" data-field="endDate" placeholder="Необязательно"/>
        </div>
        <div class="field-container">
            <input type="number" min="1" step="1" placeholder="Интервал" data-field="intervalMonths"/>
        </div>
        <div class="field-container">
            <input type="number" min="1" step="any" placeholder="Сумма" data-field="amount"/>
        </div>
        <select data-field="applicationMode">
            <option value="ON_PAYMENT_DATE">В дату платежа</option>
            <option value="BETWEEN_PAYMENTS">Между платежами</option>
        </select>
        <button type="button" class="danger" onclick="removeRow(this, 'periodic-payment-list')">×</button>
    </div>
</template>

<template id="rate-change-template">
    <div class="early-payment-row dynamic-row">
        <input type="date" data-field="startDate"/>
        <input type="number" min="0" step="0.01" placeholder="Ставка" data-field="newRate"/>
        <button type="button" class="danger" onclick="removeRow(this, 'rate-change-list')">×</button>
    </div>
</template>
</body>
</html>
